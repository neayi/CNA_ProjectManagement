<!DOCTYPE html>
<html lang="fr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Choix de la période de reporting</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous" />
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
        crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/jquery@3.7.1/dist/jquery.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jquery-ui@1.14.1/dist/jquery-ui.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/jquery-ui@1.14.1/dist/jquery-ui.min.css" rel="stylesheet" />
    
</head>

<body>
    <div class="container mt-2 px-0" style="width: 90%">

        <form id="myForm" aria-label="Dates selection form">
            <div class="row">
                <div class="col mb-3">
                    <label for="startDate" class="form-label">Date de début :</label>
                    <input type="text" id="datepickerStart" name="dateStart" 
                        autocomplete="off" readonly="readonly" style="width: 128px; text-align: right;">
                </div>
                <div class="col mb-3">
                    <label for="endDate" class="form-label">Date de fin :</label>
                    <input type="text" id="datepickerEnd" name="dateEnd" 
                        autocomplete="off" readonly="readonly" style="width: 128px; text-align: right;">
                </div>
            </div>
            <div class="row">
                <div class="col mb-3">
                    <label for="projectPicker" class="form-label">Projet : <span id="project-spinner" class="spinner-border spinner-border-sm text-primary ms-2" role="status"
                        aria-hidden="true"></span></label>
                    <select id="projectPicker" name="projectId" class="form-select" disabled>
                        <option value="">Chargement des projets...</option>
                    </select>
                    
                </div>
            </div>
            <div class="row">
                <div class="col mb-3">
                    <label for="reportingPeriodPicker" class="form-label">Reporting period : <span id="reporting-period-spinner" class="spinner-border spinner-border-sm text-primary ms-2" role="status"
                        aria-hidden="true"></span></label>
                    <select id="reportingPeriodPicker" name="reportingPeriodId" class="form-select" disabled>
                        <option value="">Sélectionner une période de reporting...</option>
                    </select>                    
                </div>
            </div>
            <div class="row">
                <div class="col mb-3">
                    <span class="form-text" id="error-text"></span>

                </div>
            </div>

            <div class="row">
                <div class="col-12 text-end">
                    <button type="button" id="submitButton" class="btn btn-primary" disabled="disabled" onclick="startGeneration()">Démarrer la génération des temps</button>
                    <button type="button" class="btn btn-secondary" onclick="cancel()">Annuler</button>
                </div>
            </div>
        </form>

        <div class="mt-5 text-center d-none" id="loading-div">
            <div class="spinner-border text-primary" role="status" id="loading-spinner">
                <span class="visually-hidden">Loading...</span>
            </div> 
            <span id="loading-text" style="top: -7px; position: relative; left: 20px;">Génération des temps en cours... veuillez patienter !</span>
        </div>

    </div>

    <script>
        function startGeneration() {
            let startDate = $("#datepickerStart").val();
            let endDate = $("#datepickerEnd").val();
            let projectId = $("#projectPicker").val();

            if (!projectId) {
                $("#error-text").text("Veuillez sélectionner un projet.");
                return;
            }

            if (!startDate || !endDate) {
                $("#error-text").text("Veuillez sélectionner les dates de début et de fin.");
                return;
            }

            const [startMonth, startYear] = startDate.split('/');
            const [endMonth, endYear] = endDate.split('/');
            startDate = new Date(Number(startYear), Number(startMonth) - 1, 1);
            endDate = new Date(Number(endYear), Number(endMonth) - 1, 1);

            if (startDate > endDate) {
                $("#error-text").text("La date de début ne peut pas être postérieure à la date de fin.");
                return;
            }

            console.log("Generating times for project ID:", projectId, "from", startDate, "to", endDate);

            google.script.run.withSuccessHandler(function () {                
                google.script.host.close();    
            }).generateTimesForDates(startDate.valueOf(), endDate.valueOf(), false, projectId);
            
            // Show a loading message
            $("#submitButton").parent().hide();
            $("#loading-div").removeClass("d-none");
        }

        function cancel() {
            google.script.host.close();
        }

        // When the page is ready, initialize the datepicker
        $(document).ready(function () {

            let reportingPeriods = [];

            // Show spinner and disable dropdown before loading
            $("#projectPicker").prop("disabled", true);
            $("#project-spinner").show();

            // Load projects from server
            google.script.run.withSuccessHandler(function (projects) {
                var $picker = $("#projectPicker");
                $picker.empty();
                if (projects && projects.length) {
                    $picker.append($('<option>', { value: '', text: 'Sélectionnez un projet...' }));
                    projects.forEach(function (proj) {
                        $picker.append($('<option>', { value: proj.id, text: proj.name }));
                    });
                } else {
                    $picker.append($('<option>', { value: '', text: 'Aucun projet disponible' }));
                }
                $picker.prop("disabled", false);
                $("#project-spinner").hide();
            }).getProjects();

            // Load projects from server
            google.script.run.withSuccessHandler(function (rp) {
                reportingPeriods = rp;
                $("#reporting-period-spinner").hide();
                $("#reportingPeriodPicker").prop("disabled", false);
            }).getReportingPeriodsForPeriodPicker();

            $('#projectPicker').on('change', function () {
                var selectedProjectId = $(this).val();
                var rpPicker = $("#reportingPeriodPicker");
                rpPicker.empty();

                if (selectedProjectId) {
                    var filteredRPs = reportingPeriods.filter(function (rp) {
                        return rp.projectId === selectedProjectId;
                    });

                    if (filteredRPs.length) {
                        rpPicker.append($('<option>', { value: '', text: 'Sélectionnez une période de reporting...' }));
                        filteredRPs.forEach(function (rp) {
                            rpPicker.append($('<option>', { value: rp.id, text: rp.name }));
                        });
                    } else {
                        rpPicker.append($('<option>', { value: '', text: 'Aucune période de reporting disponible' }));
                    }
                } else {
                    rpPicker.append($('<option>', { value: '', text: 'Sélectionner une période de reporting...' }));
                }
            });

            $("#reportingPeriodPicker").on('change', function () {
                var selectedRpId = $(this).val();
                var selectedRp = reportingPeriods.find(function (rp) {
                    return rp.id === selectedRpId;
                });

                if (selectedRp) {
                    var startDate = new Date(selectedRp.start);
                    var endDate = new Date(selectedRp.end);

                    $("#datepickerStart").val(startDate.getMonth() + 1 + '/' + startDate.getFullYear());
                    $("#datepickerEnd").val(endDate.getMonth() + 1 + '/' + endDate.getFullYear());

                    $("#submitButton").prop("disabled", false);
                }
            });
        });
    </script>
</body>

</html>